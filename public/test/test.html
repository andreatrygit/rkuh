<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="description" content="Rkuh Home" />
    <meta charset="utf-8">
    <title>Home</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Andrea Scotti">
    <link rel="stylesheet" type="text/css" href="../global.css">
    <script type="module" src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine-ie11.min.js" defer></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/ky@0.28.3/distribution/index.min.js"></script>
</head>

<body class="relative top-0 left-0">
    
    <div class="absolute top-0 left-0 w-screen min-h-screen flex flex-col justify-center items-center bg-black">
        <div class="w-full sm:w-1/2 md:w-1/3 flex flex-col flex-nowrap justify-center items-center space-y-2 p-2 transition-all duration-500"
             x-data="{state:'start', message:'', qr:false, qrCode:'', pinPad:false, pin:'', cancel:false}"
             x-init="$watch('state', s =>  
                         s==='start' ? message='', qr=false, qrCode='', pinPad=false, pin='', cancel=false
                         : s==='personal' ? message='Digita il tuo PIN.', qr=false, qrCode='', pinPad=true, pin='', cancel=true
                         : s==='personalPinCheck' ? message='Verifica del PIN in corso...', qr=false, qrCode='', pinPad=false, cancel=false
                         : s==='personalPinCheckFailed' ? message='PIN errato. CLICCAMI per riprovare.', qr=false, qrCode='', pinPad=true, pin='', cancel=true
                         : s==='personalPinCheckOk' ? $dispatch('logged-in')
                         : s==='personalPinChecktimeout' ? message='Verifica del PIN scaduta. CLICCAMI per riprpvare.', qr=false, qrCode='', pinPad=true, pin='', cancel=true
                         : s==='clocking' ? message='Scansiona il codice QR sul timbrino.', qr=true, qrCode='', pinPad=false, pin='', cancel=true
                         : s==='clockingScanFailed' ? message='Codice QR non valido. CLICCAMI per riprovare.', qr=false, qrCode='', pinPad=false, pin='', cancel=true
                         : s==='clockingScanCheck' ? message='Verifica del codice QR in corso...', qr=false, pinPad=false, pin='', cancel=false
                         : s==='clockingScanCheckFailed' ? message='Codice QR errato. CLICCAMI per riprovare.', qr=false, qrCode='', pinPad=false, pin='', cancel=true
                         : s==='clockingScanCheckTimeout' ? message='Verifica del codice QR scaduta. CLICCAMI per riprovare.', qr=false, qrCode='', pinPad=false, pin='', cancel=true
                         : s==='clockingScanCheckOk' ? message='Bene, hai timbrato. CLICCAMI per chiudermi.', qr=false, qrCode='', pinPad=false, pin='', cancel=false
                         : s==='shared' ? message='1. Scansiona il codire QR sulla postazione condivisa.', qr=true, qrCode='', pinPad=false, pin='', cancel=true
                         : s==='sharedDeviceScanFailed' ? message='Codice QR non valido. CLICCAMI per riprovare.', qr=false, qrCode='', pinPad=false, pin='', cancel=true
                         : s==='sharedDeviceScanOk' ? message='2. Ora digita il tuo PIN.', qr=false, qrCode='', pinPad=true, pin='', cancel=true
                         : s==='sharedCheck' ? message='Verifica delle credenziali in corso...', qr=false, pinPad=false, cancel=false
                         : s==='sharedCheckFailed' ? message='Credenziali errate. CLICCAMI per riprovare da capo.', qr=false, qrCode='', pinPad=false, pin='', cancel=true
                         : s==='sharedCheckTimeout' ? message='Verifica delle credenziali scaduta. CLICCAMI per riprovare da capo.', qr=false, qrCode='', pinPad=false, pin='', cancel=true
                         : s==='sharedCheckOk' ? message='Bene, puoi cliccare ACCEDI sulla postazione condivisa. CLICCAMI per chiudermi.', qr=false, qrCode='', pinPad=false, pin='', cancel=false
                         : null;);
                     $watch('pin',p=>p.length===5?state=personalPinCheck:null;);
                     $watch('state',s=>{
                     if (s==='personalPinCheck'){
                        let res;
                        try {
                            res= await ky.post('api/rest-api/login/personal/'+pin, {
                            retry:0,
                            timeout:4000}).json();
                        }
                        catch (error){
                            if (error.name==='TimeoutError'){
                                res={timeout:'Request timed out.'};
                            }
                            else{
                                res={error:error.name};
                                console.log(res);
                            }
                        }
                        res.info ? state=personalPinCheckOk : res.timeout ? state = personalPinChecktimeout : res.error ? state=personalPinCheckFailed : null;
                     };})"
             
             @pin-pad-pressed="pin.length < 5 ? pin+=$event.detail : null"
             @qr-value=""
             @message-click="state.includes('personal')?state=personal:state.includes('clocking')?state=clocking:state.includes('shared')?state=shared:null"
             @clocking="state=clocking"
             @shared="state=shared"
             @personal="state=personal"
             @home-page=""
             @cancel="state=start">
             
            <div class="btn btn-outline btn-wide btn-lg leading-tight"
                 x-bind:class="{'btn-primary':state.includes('personal'), 'btn-secondary':state.includes('shared'), 'btn-accent':state.includes('clocking')}"
                 x-show.transition.in.opacity.duration.500ms="message"
                 x-text="message"
                 @click="$dispatch('message-click')">
            </div>
            <div class="w-60 h-60 bg-gray-200 rounded-xl mb-10"
                 x-show.transition.in.opacity.duration.500ms="qr">
            </div>
            <div class="btn btn-wide btn-lg text-4xl"
                 x-bind:class="{'btn-primary':state.includes('personal'), 'btn-secondary':state.includes('shared'), 'btn-accent':state.includes('clocking')}"
                 x-show.transition.in.opacity.duration.500ms="pinPad"
                 x-text="'&bull; '.repeat(pin.length)">
            </div>
            <div class="flex flex-row flex-wrap justify-center items-center content-start w-72"
                 x-show.transition.in.opacity.duration.500ms="pinPad">
                <div class="btn btn-outline btn-primary w-20 h-20 m-1 font-semibold text-4xl" x-bind:class="{'btn-primary':state.includes('personal'), 'btn-secondary':state.includes('shared'), 'btn-accent':state.includes('clocking')}" @click="$dispatch('pin-pad-pressed','1')">1</div>
                <div class="btn btn-outline btn-primary w-20 h-20 m-1 font-semibold text-4xl" x-bind:class="{'btn-primary':state.includes('personal'), 'btn-secondary':state.includes('shared'), 'btn-accent':state.includes('clocking')}" @click="$dispatch('pin-pad-pressed','2')">2</div>
                <div class="btn btn-outline btn-primary w-20 h-20 m-1 font-semibold text-4xl" x-bind:class="{'btn-primary':state.includes('personal'), 'btn-secondary':state.includes('shared'), 'btn-accent':state.includes('clocking')}" @click="$dispatch('pin-pad-pressed','3')">3</div>
                <div class="btn btn-outline btn-primary w-20 h-20 m-1 font-semibold text-4xl" x-bind:class="{'btn-primary':state.includes('personal'), 'btn-secondary':state.includes('shared'), 'btn-accent':state.includes('clocking')}" @click="$dispatch('pin-pad-pressed','4')">4</div>
                <div class="btn btn-outline btn-primary w-20 h-20 m-1 font-semibold text-4xl" x-bind:class="{'btn-primary':state.includes('personal'), 'btn-secondary':state.includes('shared'), 'btn-accent':state.includes('clocking')}" @click="$dispatch('pin-pad-pressed','5')">5</div>
                <div class="btn btn-outline btn-primary w-20 h-20 m-1 font-semibold text-4xl" x-bind:class="{'btn-primary':state.includes('personal'), 'btn-secondary':state.includes('shared'), 'btn-accent':state.includes('clocking')}" @click="$dispatch('pin-pad-pressed','6')">6</div>
                <div class="btn btn-outline btn-primary w-20 h-20 m-1 font-semibold text-4xl" x-bind:class="{'btn-primary':state.includes('personal'), 'btn-secondary':state.includes('shared'), 'btn-accent':state.includes('clocking')}" @click="$dispatch('pin-pad-pressed','7')">7</div>
                <div class="btn btn-outline btn-primary w-20 h-20 m-1 font-semibold text-4xl" x-bind:class="{'btn-primary':state.includes('personal'), 'btn-secondary':state.includes('shared'), 'btn-accent':state.includes('clocking')}" @click="$dispatch('pin-pad-pressed','8')">8</div>
                <div class="btn btn-outline btn-primary w-20 h-20 m-1 font-semibold text-4xl" x-bind:class="{'btn-primary':state.includes('personal'), 'btn-secondary':state.includes('shared'), 'btn-accent':state.includes('clocking')}" @click="$dispatch('pin-pad-pressed','9')">9</div>
                <div class="btn btn-outline btn-primary w-20 h-20 m-1 font-semibold text-4xl" x-bind:class="{'btn-primary':state.includes('personal'), 'btn-secondary':state.includes('shared'), 'btn-accent':state.includes('clocking')}" @click="$dispatch('pin-pad-pressed','0')">0</div>
            </div>
            <div class="btn btn-wide btn-lg btn-accent" @click="$dispatch('clocking')" x-show.transition.in.opacity.duration.500ms="state==='start'">TIMBRA</div>
            <div class="btn btn-wide btn-lg btn-secondary leading-tight" @click="$dispatch('shared')" x-show.transition.in.opacity.duration.500ms="state==='start'">ENTRA SU POSTAZIONE CONDIVISA</div>
            <div class="btn btn-wide btn-lg btn-primary" @click="$dispatch('personal')" x-show.transition.in.opacity.duration.500ms="state==='start'">ENTRA QUI</div>
            <div class="btn btn-outline btn-wide btn-lg btn-ghost" @click="$dispatch('home-page')" x-show.transition.in.opacity.duration.500ms="state==='start'">VISITA HOME PAGE</div>
            <div class="btn btn-outline btn-wide btn-lg btn-ghost" @click="$dispatch('cancel')" x-show.transition.in.opacity.duration.500ms="cancel">ANNULLA</div>
        </div>
    </div>
</body>